services:
  # ===========================
  # Node.js Backend (replaces Strapi)
  # ===========================
  node-backend:
    build:
      context: ./node-backend
      dockerfile: Dockerfile
    container_name: node-backend
    restart: unless-stopped
    expose:
      - "4000"
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: postgresql://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@backend-db:5432/${DATABASE_NAME}?schema=public
      VIRTUAL_HOST: api.africasoccer.com
      LETSENCRYPT_HOST: api.africasoccer.com
      LETSENCRYPT_EMAIL: jaivinpatel@tricoreitsolutions.com
      HTTPS_METHOD: redirect
    depends_on:
      - backend-db

  backend-db:
    image: postgres:17
    container_name: backend-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    ports:
      - "5433:5432"
    volumes:
      - ${POSTGRES_DATA_PATH}:/var/lib/postgresql/data

  # ===========================
  # Next.js Admin Dashboard
  # ===========================
  admin-dashboard:
    build:
      context: ./admin-dashboard
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    container_name: nextjs-admin
    restart: unless-stopped
    expose:
      - "3033"
    env_file:
      - .env
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - VIRTUAL_HOST=fbadmin.africasoccer.com
      - LETSENCRYPT_HOST=fbadmin.africasoccer.com
      - LETSENCRYPT_EMAIL=jaivinpatel@tricoreitsolutions.com
      - HTTPS_METHOD=redirect
    depends_on:
      - node-backend

  # ===========================
  # Python News Engine
  # ===========================
  news-engine:
    build:
      context: ./news-engine
      dockerfile: Dockerfile
    container_name: news-engine
    restart: unless-stopped
    expose:
      - "8000"
    env_file:
      - .env
    environment:
      - VIRTUAL_HOST=fbpyapi.africasoccer.com
      - LETSENCRYPT_HOST=fbpyapi.africasoccer.com
      - LETSENCRYPT_EMAIL=jaivinpatel@tricoreitsolutions.com
      - HTTPS_METHOD=redirect
    depends_on:
      - python-db
      - node-backend
    volumes:
    build:
      context: ./news-engine
      dockerfile: Dockerfile
    container_name: news-engine-cron
    command: ["python3", "-u", "cron_all.py"]  # -u flag for unbuffered output
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1  # Ensure unbuffered output for logs
    depends_on:
      - python-db
    volumes:
      - ./news-engine:/app

  python-db:
    image: postgres:17
    container_name: python-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5444:5432"
    volumes:
      - ${PYTHON_DB_DATA_PATH}:/var/lib/postgresql/data
